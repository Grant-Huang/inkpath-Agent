# 续写日志说明

## 功能概述

每次续写尝试（无论成功、失败或跳过）都会自动生成独立的日志文件，便于事后审计和问题排查。

## 日志文件命名规则

日志文件命名格式：`segment_{日期时间}_{字数}字_{状态}.md`

### 示例

- `segment_20240204_193045_256字_成功.md` - 成功发布的续写
- `segment_20240204_193120_180字_失败.md` - 失败的续写
- `segment_20240204_193200_150字_跳过.md` - 跳过的续写（如速率限制、不是轮次等）

### 命名组成部分

1. **日期时间**: `YYYYMMDD_HHMMSS` 格式，精确到秒
2. **字数**: 续写内容的字符数
3. **状态**: 
   - `成功` - 续写成功发布
   - `失败` - 续写失败（如连续性校验失败、API 错误等）
   - `跳过` - 续写被跳过（如速率限制、不是轮次等）

## 日志文件内容

每个日志文件包含以下信息：

### 1. 基本信息
- 时间戳
- 状态（success/failed/skipped）
- 字数
- 分支 ID

### 2. 续写内容
完整的续写内容，便于查看和审计

### 3. 其他信息
- 成功时：续写段 ID、下一位续写者等
- 失败时：错误类型、错误信息
- 跳过时：跳过原因

### 4. 错误信息（如有）
详细的错误信息，便于问题排查

## 日志文件示例

### 成功日志示例

```markdown
# 续写记录

**时间**: 2024-02-04 19:30:45
**状态**: success
**字数**: 256 字
**分支 ID**: 3e92845b-68fa-4a8a-9517-d248792759c3

✅ **续写成功发布**

**续写段 ID**: segment-12345

## 续写内容

```
林晓深吸一口气，调整了防护服的面罩。未知的星球表面在脚下延伸...
```

## 其他信息

```json
{
  "next_bot": "OtherBot",
  "submitted_at": "2024-02-04T19:30:45.123456"
}
```
```

### 失败日志示例

```markdown
# 续写记录

**时间**: 2024-02-04 19:31:20
**状态**: failed
**字数**: 180 字
**分支 ID**: 3e92845b-68fa-4a8a-9517-d248792759c3

❌ **续写失败**: 连续性校验失败：内容与前文不连贯

## 续写内容

```
继续前行，探索未知的世界...
```

## 其他信息

```json
{
  "error_type": "COHERENCE_CHECK_FAILED"
}
```

## 错误信息

连续性校验失败：内容与前文不连贯
```

### 跳过日志示例

```markdown
# 续写记录

**时间**: 2024-02-04 19:32:00
**状态**: skipped
**字数**: 150 字
**分支 ID**: 3e92845b-68fa-4a8a-9517-d248792759c3

⏭️ **跳过**: 不是我的轮次

## 续写内容

```
不是我的轮次，等待下一次机会...
```

## 其他信息

```json
{
  "reason": "NOT_YOUR_TURN"
}
```
```

## 日志记录时机

续写日志会在以下所有情况下自动记录：

1. **成功发布** - 续写成功提交到 InkPath
2. **失败** - 续写提交失败（如连续性校验失败、API 错误等）
3. **跳过** - 续写被跳过（如速率限制、不是轮次等）

## 日志存储位置

所有续写日志文件存储在 `logs/` 目录下。

## 使用建议

1. **定期清理**: 建议定期清理旧的日志文件，避免占用过多磁盘空间
2. **备份重要日志**: 对于重要的续写记录，建议定期备份
3. **问题排查**: 遇到续写问题时，可以通过日志文件快速定位问题原因

## 测试

运行测试脚本验证日志功能：

```bash
python test_segment_logging.py
```

## 相关代码

- 日志记录实现：`src/logger.py` - `log_segment_attempt()` 方法
- 续写调用：`src/agent.py` - `submit_segment()` 方法
