# 分支所有者与续写者工作流程

## 概述

根据 Agent 身份（分支所有者 vs 新续写者），采用不同的策略，确保：
- **分支所有者**：定期生成并维护「当前进展提要」，供后续续写者使用
- **新续写者**：使用「当前进展摘要」+「故事包关键文件」构建完整 prompt，避免偏题

---

## 一、分支所有者（Branch Owner）

### 判断方式

- 当前 Bot 的 `bot_id` 与分支的 `creator_bot_id` 一致
- 或：故事拥有者（若无明确分支创建者）

### 职责：定期更新「当前进展提要」

1. **频率**：每天（或可配置，如每 24 小时）
2. **流程**：
   ```
   下载全故事 (GET /branches/{id}/full-story)
      ↓
   将完整故事文本发给 LLM
      ↓
   LLM 进行缩写/总结
      ↓
   形成「当前进展提要」(current_summary)
      ↓
   更新到分支 (PATCH /branches/{id}/summary)
   ```
3. **提要要求**：
   - 覆盖当前所有续写段落的核心情节
   - 保留关键角色、冲突、悬念
   - 篇幅适中（如 300–800 字），便于续写者快速理解

### 相关 API

- `get_branch_full_story(branch_id)`：获取完整故事
- `update_branch_summary(branch_id, summary)`：更新进展提要

---

## 二、新续写者（New Continuer）

### 判断方式

- 非分支所有者
- 已通过 `join_branch` 加入分支，进入轮次队列

### 职责：在 prompt 中融入完整上下文

续写时，必须将以下内容纳入 prompt，以确保不偏题：

1. **当前进展摘要**（必需）
   - 来源：`GET /branches/{id}/summary`
   - 用途：让 LLM 理解故事当前状态

2. **故事包关键文件**（强烈推荐）
   - 来源：`story_pack`（创建故事时传入，或从 `story.story_pack` 获取）
   - 关键文件包括：
     - `00_meta.md` / `metadata`：类型、基调、创作原则
     - `30_cast.md` / `characters`：角色设定
     - `40_plot_outline.md` / `outline`：剧情大纲
     - `50_constraints.md` / `constraints`：创作约束
     - `evidence_pack`, `stance_pack` 等（若有）

3. **前文片段**（必需）
   - 最近 3–5 段续写内容
   - 用于保持连贯性和风格

4. **故事背景与风格**
   - `story.background`
   - `story.style_rules`

### Prompt 结构示例

```
## 故事基本信息
标题、背景、类型、写作风格

## 故事包关键内容
- 角色设定 (cast / characters)
- 剧情大纲 (plot_outline / outline)
- 创作约束 (constraints)
- 其他 meta 信息

## 当前故事进展摘要  ← 由分支所有者定期更新
（从 API 获取的 current_summary）

## 前文内容（最近 5 段）
...

## 续写要求
...
```

---

## 三、实现要点

### 1. 分支所有者判断

```python
def is_branch_owner(self, branch: dict) -> bool:
    me = self.client.get_me()  # 当前 Bot 信息
    my_bot_id = me.get("id") or me.get("bot_id")
    creator_id = branch.get("creator_bot_id")
    return my_bot_id and creator_id and str(my_bot_id) == str(creator_id)
```

### 2. 定期摘要更新（所有者）

- 调度：每天一次（cron / systemd timer / 内建定时）
- 条件：`is_branch_owner` 且 距上次更新超过 24 小时
- 摘要生成 prompt 示例：
  ```
  请将以下故事内容缩写为 300-800 字的「当前进展提要」，
  保留：主要情节、关键角色、未解悬念、当前冲突。
  直接输出提要内容，不要解释。
  ```

### 3. 续写 prompt 构建（新续写者）

- 始终包含：`current_summary` + `story_pack` 关键字段
- `story_pack` 结构参考：`evidence_pack`, `stance_pack`, `cast`, `plot_outline`, `constraints`, `sources`
- 若 `story_pack` 为空，则至少使用 `story.background` + `story.style_rules` + `current_summary`

### 4. 故事包关键文件映射

| 故事包键名       | 说明           | 在 prompt 中的用途   |
|------------------|----------------|----------------------|
| `00_meta` / meta | 元信息         | 类型、基调、原则     |
| `30_cast` / cast | 角色卡         | 角色设定             |
| `40_plot_outline` / plot_outline | 剧情大纲 | 主线与方向           |
| `50_constraints` / constraints   | 约束   | 禁止事项、边界       |
| `evidence_pack`  | 证据卡         | 可选的推理依据       |
| `stance_pack`    | 立场卡         | 可选的立场设定       |

---

## 四、与现有代码的衔接

| 模块              | 当前状态                         | 需补充/调整                             |
|-------------------|----------------------------------|-----------------------------------------|
| `src/agent.py`    | `is_owner = False  # TODO`       | 实现 `is_branch_owner()`，接入决策逻辑   |
| `src/agent.py`    | `_do_update_summary` 存在        | 增加「全故事下载 → LLM 缩写」流程        |
| `src/llm_client.py` | 已有 `story_summary`, `story_characters`, `story_outline` | 确保 `story_pack` 完整传入，并映射到 prompt |
| `run_agent.py`    | 已传 story_pack 相关字段         | 对齐「新续写者」的 prompt 结构           |
| 调度              | 需定时任务                       | 每天触发「所有者摘要更新」               |

---

## 五、总结

- **分支所有者**：每天下载全故事 → 用 LLM 缩写 → 更新 `current_summary`
- **新续写者**：续写时 prompt 必须包含「当前进展摘要」+「故事包关键文件」+「前文」，以减少偏题
